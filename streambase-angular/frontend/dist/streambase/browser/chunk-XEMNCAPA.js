import{a as f,i as O}from"./chunk-VFXDPC4I.js";import{$ as M,H as n,Y as a,ca as m,ia as l,nb as E,r as c,u as o}from"./chunk-EDYQIVRR.js";var g=class p{MOVIE_REQUESTS_API_ENDPOINT="/movie-requests";TMDB_SEARCH_ENDPOINT="/search";api=l(O);jsonMovies=E([]);constructor(){this.fetchJSONMovies().subscribe({next:e=>{this.jsonMovies.set(e)}})}fetchJSONMovies(){return this.api.get("/movies").pipe(o(e=>!e||e.length===0?(console.error("No movies found"),[]):e),M(e=>{this.jsonMovies.set(e)}))}getJSONMovies(){return this.jsonMovies()}getJSONMovieById(e){return this.jsonMovies().find(t=>t.id===e)}addJSONMovie(e){return this.api.post("/movies",e).pipe(o(t=>(this.jsonMovies.update(i=>[...i,t]),t)))}updateJSONMovie(e){return this.api.put(`/movies/${e.id}`,e).pipe(o(t=>(this.jsonMovies.update(i=>i.map(s=>s.id===t.id?t:s)),t)))}deleteJSONMovie(e){return this.api.delete(`/movies/${e}`).pipe(o(()=>{this.jsonMovies.update(t=>t.filter(i=>i.id!==e))}))}getCurrentTimestamp(){return new Date().toISOString()}fetchMovieRequests(){return this.api.get(this.MOVIE_REQUESTS_API_ENDPOINT).pipe(n(this.handleError))}approveMovieRequest(e,t,i){let s=`${this.TMDB_SEARCH_ENDPOINT}/${i}`,u="/movies";return this.api.get(`${u}?title=${encodeURIComponent(t)}`).pipe(a(()=>this.api.getTMDB(s,new f().set("query",t)).pipe(a(v=>{if(!v.results||v.results.length===0)throw this.declineMovieRequest(e,"Movie not found on TMDB"),new Error("Movie not found on TMDB");let r=v.results[0],d=this.getCurrentTimestamp(),h={id:String(r.id),title:r.title,media_type:r.media_type||i||"movie",poster:r.poster_path,backdrop:r.backdrop_path,released:r.release_date||r.first_air_date,createdAt:d,updatedAt:d};return this.api.post(u,h).pipe(a(()=>{this.jsonMovies.update(N=>[...N,h]);let _={status:"approved",updatedAt:d,tmdb_id:h.id};return this.api.patch(`${this.MOVIE_REQUESTS_API_ENDPOINT}/${e}`,_)}))}))),n(this.handleError))}declineMovieRequest(e,t){let i={status:"declined",updatedAt:this.getCurrentTimestamp(),reason:t||"No reason provided"};return this.api.patch(`${this.MOVIE_REQUESTS_API_ENDPOINT}/${e}`,i).pipe(n(this.handleError))}handleError(e){let t=e?.message||"Unknown error occurred";return c(()=>new Error(t))}static \u0275fac=function(t){return new(t||p)};static \u0275prov=m({token:p,factory:p.\u0275fac,providedIn:"root"})};export{g as a};
